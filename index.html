<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Жизнь Матвея - Симулятор выживания</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --color-bg: #1a1a1a;
            --color-surface: #2a2a2a;
            --color-text: #e0e0e0;
            --color-text-dim: #999;
            --color-primary: #4a9eff;
            --color-danger: #ff4444;
            --color-warning: #ffaa00;
            --color-success: #44ff44;
            --color-border: #444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
        }

        /* Telegram Mini App adaptations */
        body.telegram {
            padding: 10px;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #e0e0e0);
        }

        .telegram .game-container {
            max-width: 100%;
        }

        .telegram header {
            margin-bottom: 15px;
            padding: 15px;
        }

        .telegram h1 {
            font-size: 1.8em;
        }

        .telegram .action-btn {
            min-height: 50px;
            font-size: 1.05em;
            touch-action: manipulation;
        }

        .telegram .main-content {
            gap: 15px;
        }

        .telegram .stat-item {
            margin-bottom: 8px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--color-surface);
            border-radius: 10px;
            border: 2px solid var(--color-border);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .subtitle {
            color: var(--color-text-dim);
            font-size: 1.1em;
        }

        .day-counter {
            font-size: 1.5em;
            margin-top: 10px;
            color: var(--color-warning);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .stats-panel {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-border);
        }

        .stat {
            margin-bottom: 20px;
        }

        .stat-name {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            color: var(--color-text-dim);
        }

        .progress-bar {
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .progress-health { background: linear-gradient(90deg, #ff4444, #ff6666); }
        .progress-mood-red { background: linear-gradient(90deg, #ff4444, #ff6666); }
        .progress-mood-orange { background: linear-gradient(90deg, #ffaa00, #ffcc44); }
        .progress-mood-yellow { background: linear-gradient(90deg, #ffdd44, #ffee66); }
        .progress-mood-green { background: linear-gradient(90deg, #44ff44, #66ff66); }
        .progress-satiety { background: linear-gradient(90deg, #44ff44, #66ff66); }
        .progress-adequacy { background: linear-gradient(90deg, #4a9eff, #6ab0ff); }
        .progress-incel { background: linear-gradient(90deg, #9944ff, #aa66ff); }
        .progress-god { background: linear-gradient(90deg, #ff00ff, #ff44ff); }
        .progress-fatigue-low { background: linear-gradient(90deg, #44ff44, #66ff66); }
        .progress-fatigue-medium { background: linear-gradient(90deg, #ffaa00, #ffcc44); }
        .progress-fatigue-high { background: linear-gradient(90deg, #ff4444, #ff6666); }

        .money-display {
            font-size: 1.5em;
            color: var(--color-success);
            text-align: center;
            padding: 15px;
            background: #1a3a1a;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid var(--color-success);
        }

        .money-display.debt {
            color: var(--color-danger);
            background: #3a1a1a;
            border-color: var(--color-danger);
            animation: pulse 1.5s infinite;
        }

        .debt-counter {
            font-size: 0.9em;
            color: var(--color-danger);
            text-align: center;
            padding: 10px;
            background: #3a1a1a;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid var(--color-danger);
            animation: pulse 2s infinite;
        }

        .debt-counter.critical {
            animation: pulse 0.8s infinite;
            font-weight: bold;
        }

        .event-log {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-border);
            height: 600px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        #eventLog {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .event-log::-webkit-scrollbar {
            width: 10px;
        }

        .event-log::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 5px;
        }

        .event-log::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 5px;
        }

        .event-log::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }



        .event-log h2 {
            color: var(--color-primary);
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            border-left: 3px solid var(--color-primary);
            animation: slideIn 0.3s ease;
        }

        .log-entry.event {
            border-left-color: var(--color-warning);
        }

        .log-entry.danger {
            border-left-color: var(--color-danger);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .actions-panel {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-border);
        }

        .actions-panel h2 {
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .action-btn {
            padding: 15px;
            background: #333;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .action-btn:hover:not(:disabled) {
            background: #444;
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background: var(--color-primary);
            color: #fff;
            font-weight: bold;
        }

        .action-btn.primary:hover:not(:disabled) {
            background: #3a8eef;
        }

        .action-icon {
            font-size: 1.5em;
            margin-right: 8px;
        }

        .achievements {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-border);
            margin-top: 20px;
        }

        .achievements h2 {
            margin-bottom: 15px;
            color: var(--color-warning);
        }

        .achievement {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: #1a1a1a;
            border-radius: 20px;
            border: 2px solid var(--color-warning);
            font-size: 0.9em;
        }

        .achievement.locked {
            opacity: 0.3;
            border-color: var(--color-border);
        }

        .game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: var(--color-surface);
            padding: 40px;
            border-radius: 15px;
            border: 3px solid var(--color-danger);
            text-align: center;
            max-width: 500px;
        }

        .game-over-content h2 {
            font-size: 3em;
            color: var(--color-danger);
            margin-bottom: 20px;
        }

        .restart-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: var(--color-primary);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .restart-btn:hover {
            background: #3a8eef;
            transform: scale(1.05);
        }

        .stat-alert {
            color: var(--color-danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            animation: slideInRight 0.5s ease-out;
            max-width: 400px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .toast.hidden {
            display: none;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toast-icon {
            font-size: 2em;
        }

        .toast-text {
            flex: 1;
            line-height: 1.4;
        }

        .toast-text strong {
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.fade-out {
            animation: slideOutRight 0.5s ease-in forwards;
        }

        @media (max-width: 768px) {
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Tooltips */
        .action-btn {
            position: relative;
        }

        .action-btn::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: #1a1a1a;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .action-btn::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            border: 6px solid transparent;
            border-top-color: #1a1a1a;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }

        .action-btn:hover::before,
        .action-btn:hover::after {
            opacity: 1;
        }

        .action-btn:hover::before {
            transform: translateX(-50%) translateY(-12px);
        }

        .action-btn:hover::after {
            transform: translateX(-50%) translateY(-6px);
        }

        .action-btn:disabled::before {
            background: #ff4444;
            border-color: #ff6666;
        }

        .action-btn:disabled::after {
            border-top-color: #ff4444;
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.02);
        }

        .action-btn:disabled:hover {
            transform: none;
        }

        @media (max-width: 768px) {
            .action-btn::before {
                font-size: 0.75em;
                padding: 6px 10px;
                white-space: normal;
                max-width: 200px;
                text-align: center;
            }
        }

        .work-choice-card {
            transition: all 0.2s ease;
        }

        .work-choice-card:hover {
            border-color: var(--color-primary) !important;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header>
            <h1>🏙️ Жизнь Матвея</h1>
            <p class="subtitle">Симулятор выживания в Санкт-Петербурге</p>
            <div class="day-counter">День: <span id="dayCounter">1</span></div>
        </header>

        <div class="main-content">
            <div class="stats-panel">
                <h2>📊 Параметры</h2>
                
                <div class="stat">
                    <div class="stat-name">
                        <span>❤️ Здоровье</span>
                        <span class="stat-value" id="healthValue">100</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-health" id="healthBar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>😊 Настроение</span>
                        <span class="stat-value" id="moodValue">50</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-mood" id="moodBar" style="width: 50%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>🍔 Сытость</span>
                        <span class="stat-value" id="satietyValue">100</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-satiety" id="satietyBar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>🧠 Адекватность</span>
                        <span class="stat-value" id="adequacyValue">20</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-adequacy" id="adequacyBar" style="width: 20%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>🤡 Инцельность</span>
                        <span class="stat-value" id="incelValue">80</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-incel" id="incelBar" style="width: 80%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>👑 Комплекс Бога</span>
                        <span class="stat-value" id="godComplexValue">40</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-god" id="godComplexBar" style="width: 40%"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat-name">
                        <span>😴 Усталость</span>
                        <span class="stat-value" id="fatigueValue">0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-fatigue-low" id="fatigueBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="money-display" id="moneyDisplay">
                    💰 <span id="moneyValue">25,000</span> ₽
                </div>
                <div class="debt-counter" id="debtCounter" style="display: none;">
                    ⚠️ Дней в долгу: <span id="debtDays">0</span>/7
                </div>

                <div class="stat" style="margin-top: 20px;">
                    <div class="stat-name">
                        <span>💖 Отношения с Викой</span>
                        <span class="stat-value" id="vikaRelationshipValue">0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="vikaRelationshipBar" style="width: 0%; background: linear-gradient(90deg, #ff1493, #ff69b4);"></div>
                    </div>
                    <div style="font-size: 0.85em; color: var(--color-text-dim); margin-top: 5px;">Показывает шанс контакта и финальную концовку</div>
                </div>
            </div>

            <div class="event-log">
                <h2 style="position: sticky; top: 0; background: var(--color-surface); z-index: 10; margin: -20px -20px 15px -20px; padding: 20px; border-bottom: 2px solid var(--color-border);">📜 События</h2>
                <div id="eventLog">
                    <!-- Events dynamically added here via JavaScript -->
                </div>
            </div>
        </div>

        <div class="actions-panel">
            <h2>🎮 Действия</h2>
            <div class="actions-grid">
                <button class="action-btn" onclick="work()" data-tooltip="Выбери: Асфальт (тяжело, 2200-3800₽) или Доставка (легче, 800-1500₽)"><span class="action-icon">💼</span>Работать</button>
                <button class="action-btn" onclick="wash()" data-tooltip="🧠 +8 адекватности | 🔻 -8 инцельности | 😴 +6 | (25% шанс: 📸 сфоткать пенис)"><span class="action-icon">🚿</span>Помыться</button>
                <button class="action-btn" onclick="shave()" data-tooltip="🧠 +7 адекватности | 🔻 -7 инцельности | 😴 +4 | (35% шанс: 🤳 селфи)"><span class="action-icon">🪒</span>Побриться</button>
                <button class="action-btn" onclick="goOutside()" data-tooltip="🧠 +8 адекватности | 😴 +18 усталости | 😊 +3 настроения" id="goOutsideBtn"><span class="action-icon">🚪</span>Выйти из дома</button>
                <button class="action-btn" onclick="askParentsFood()" id="askFoodBtn" data-tooltip="🍔 +35 сытости | 😊 -8 настроения | Лимит: 3 раза в день"><span class="action-icon">🏠</span>Попросить еду у родителей</button>
                <button class="action-btn" onclick="eatTrash()" data-tooltip="🍔 +25 сытости | 📈 +15 инцельности | ❤️ -8 здоровья | 🧠 -5 адекватности"><span class="action-icon">🗑️</span>Поесть из помойки</button>
                <button class="action-btn" onclick="callVika()" id="callVikaBtn" data-tooltip="💰 -10000₽ | 🧠 требует 35+ адекватности | 😴 +20 | Шанс успеха: 75%"><span class="action-icon">📞</span>Позвонить Вике</button>
                <button class="action-btn" onclick="postAyaech()" data-tooltip="😊 +8 настроения | 📈 +8 инцельности | 😴 +12 усталости" id="postBtn"><span class="action-icon">📱</span>Постить в АЯЕЧ</button>
                <button class="action-btn" onclick="masturbate()" id="masturbate-btn" data-tooltip="😊 +8 настроения | ❤️ +2 здоровья | 📈 +10 инцельности | 🧠 -10 адекватности | 😴 +7 усталости | Блокируется при усталости ≥80"><span class="action-icon">🙈</span>Дрочка</button>
                <button class="action-btn" onclick="orderMamba()" id="mambaBtn" data-tooltip="💰 -8000₽ | 😊 +35 настроения | ❤️ -18 здоровья | 😴 +10 усталости"><span class="action-icon">💊</span>Заказать Мамбу</button>
                <button class="action-btn" onclick="goToHospital()" id="hospitalBtn" data-tooltip="❤️ +25 здоровья | 💰 -2000₽ | 😴 +15 | 😊 -10 | 🧠 +5 | 1 раз/день"><span class="action-icon">🏥</span>Сходить в больницу</button>
                <button class="action-btn" onclick="rideMetro()" id="metroBtn" data-tooltip="👑 -25 комплекса бога | 📈 +18 инцельности | 😴 +15 | 💰 -50₽ | 😊 +3 | 🧠 -3"><span class="action-icon">🚇</span>Метро</button>
                <button class="action-btn primary" onclick="sleep()" data-tooltip="Переход к следующему дню | 😴 усталость /2 | ⚠️ Проверка долгов и депрессии"><span class="action-icon">😴</span>Спать (след. день)</button>
            </div>
        </div>

        <div class="achievements">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>🏆 Достижения</h2>
                <div>
                    <button class="action-btn" onclick="showAchievements()" style="padding: 8px 16px; margin-right: 10px; background: var(--color-warning); color: #000;">🏆 Все достижения</button>
                    <button class="action-btn" onclick="showStatistics()" style="padding: 8px 16px; background: var(--color-success); color: #000;">📊 Статистика</button>
                </div>
            </div>
            <div id="achievementsList">
                <div class="achievement locked">🎖️ Неделя (7 дней)</div>
                <div class="achievement locked">🎖️ Две недели (14)</div>
                <div class="achievement locked">🎖️ Три недели (21)</div>
            </div>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h2>💀 GAME OVER</h2>
            <p id="gameOverReason" style="font-size: 1.2em; margin: 20px 0;"></p>
            <p>Дней прожито: <strong id="finalDays">0</strong></p>
            <button class="restart-btn" onclick="restartGame()">🔄 Начать заново</button>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="game-over-modal" id="tutorialModal" style="display: flex;">
        <div class="game-over-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-color: var(--color-primary);">
            <h2 style="color: var(--color-primary);">🎮 Добро пожаловать в жизнь Матвея!</h2>
            <p style="margin: 15px 0; text-align: left;">
                Ты - Матвей, 25-летний инцел из Питера. Твоя цель - выжить как можно дольше.
            </p>
            <h3 style="color: var(--color-warning); margin-top: 20px;">📊 ПАРАМЕТРЫ:</h3>
            <div style="text-align: left; margin: 15px 0; line-height: 1.8;">
                <p><strong>❤️ ЗДОРОВЬЕ (0-100)</strong><br>
                Физическое состояние. При 0 - смерть.<br>
                <span style="color: #44ff44;">↑ Повышается:</span> дрочка, больница<br>
                <span style="color: #ff4444;">↓ Понижается:</span> работа, Мамба, гопники, помойка</p>

                <p><strong>😊 НАСТРОЕНИЕ (0-100)</strong><br>
                Психологическое состояние. При &lt;20 три дня подряд - риск суицида.<br>
                <span style="color: #44ff44;">↑ Повышается:</span> дрочка, Мамба, постинг, Вика<br>
                <span style="color: #ff4444;">↓ Понижается:</span> работа, просить еду, больница</p>

                <p><strong>🍔 СЫТОСТЬ (0-100)</strong><br>
                Голод. При 0 более 3 дней - смерть от голода.<br>
                <span style="color: #44ff44;">↑ Повышается:</span> еда от родителей, помойка<br>
                <span style="color: #ff4444;">↓ Понижается:</span> каждый день -25</p>

                <p><strong>🧠 АДЕКВАТНОСТЬ (0-100)</strong><br>
                Насколько ты вменяем. Влияет на шанс с Викой.<br>
                <span style="color: #44ff44;">↑ Повышается:</span> гигиена, выход из дома, больница<br>
                <span style="color: #ff4444;">↓ Понижается:</span> дрочка, помойка, постинг</p>

                <p><strong>🤡 ИНЦЕЛЬНОСТЬ (0-100)</strong><br>
                Уровень деградации. Противоположна адекватности, влияет на Вику.<br>
                <span style="color: #ff4444;">↑ Повышается:</span> дрочка, помойка, постинг, гопники<br>
                <span style="color: #44ff44;">↓ Понижается:</span> гигиена, выход из дома</p>

                <p><strong>👑 КОМПЛЕКС БОГА (0-100)</strong><br>
                Раздутое ЭГО. При &gt;50 <strong>блокирует</strong> гигиену и выход из дома. При 100 - game over.<br>
                <span style="color: #ff4444;">↑ Повышается:</span> фотка пениса, успешный звонок Вике<br>
                <span style="color: #44ff44;">↓ Понижается:</span> неудачный звонок Вике, гопники</p>

                <p><strong>😴 УСТАЛОСТЬ (0-100)</strong><br>
                Утомление. При &gt;80 блокирует работу, прогулки, постинг.<br>
                <span style="color: #ff4444;">↑ Повышается:</span> все активные действия<br>
                <span style="color: #44ff44;">↓ Понижается:</span> сон (вдвое)</p>

                <p><strong>💰 ДЕНЬГИ</strong><br>
                Нужны для Вики (10,000₽), Мамбы (8,000₽), больницы (2,000₽), ЖКХ (5,000₽ каждые 7 дней).<br>
                <span style="color: #44ff44;">⚡ Работа:</span> Выбирай между асфальтом (тяжело, 2200-3800₽) и доставкой (легче, 800-1500₽).<br>
                <span style="color: #ff4444;">⚠️ ВАЖНО:</span> Если у тебя нет денег, гопники бьют сильнее!</p>

                <p><strong>💖 ОТНОШЕНИЯ С ВИКОЙ (0-100)</strong><br>
                Новый параметр влияет на итоговую концовку.<br>
                <span style="color: #44ff44;">↑ Повышается:</span> успешные звонки +10, встреча +20<br>
                <span style="color: #ff4444;">↓ Понижается:</span> неудачные звонки -15, депрессия -10/день<br>
                При 100/100 - финальная концовка с Викой!</p>
            </div>
            <h3 style="color: var(--color-danger); margin-top: 20px;">⚠️ GAME OVER при:</h3>
            <ul style="text-align: left; line-height: 1.8;">
                <li>Здоровье = 0</li>
                <li>Голод 3+ дня</li>
                <li>Комплекс бога = 100</li>
                <li>Успешный суицид (при настроении &lt;20 три дня подряд)</li>
                <li><strong>Долг 7+ дней подряд</strong></li>
            </ul>
            <p style="margin-top: 20px; font-weight: bold;">Удачи в выживании!</p>
            <button class="restart-btn" onclick="closeTutorial()">Начать игру</button>
        </div>
    </div>

    <!-- Work Choice Modal -->
    <div class="game-over-modal" id="workChoiceModal">
        <div class="game-over-content" style="max-width: 700px; border-color: var(--color-warning);">
            <h2 style="color: var(--color-warning);">💼 Выбор работы</h2>
            <p style="margin: 15px 0;">Матвей может подработать. Выбери профессию:</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid #666; cursor: pointer;" onclick="chooseWork('asphalt')" class="work-choice-card">
                    <h3 style="color: #ffaa00; margin-bottom: 10px;">🚧 Укладчик асфальта</h3>
                    <div style="text-align: left; line-height: 1.8; font-size: 0.9em;">
                        <p><strong>💰 Деньги:</strong> 2200-3800₽</p>
                        <p><strong>❤️ Здоровье:</strong> -15</p>
                        <p><strong>😴 Усталость:</strong> +25</p>
                        <p><strong>😊 Настроение:</strong> -8</p>
                        <p><strong>🤡 Инцельность:</strong> +8</p>
                        <p><strong>🧠 Адекватность:</strong> +3</p>
                        <hr style="border: 1px solid #333; margin: 10px 0;">
                        <p style="font-size: 0.85em; color: #aaa;"><strong>События:</strong><br>
                        • Скандал с коллегами (12%)<br>
                        • Начальник похвалил (6%)<br>
                        • Штраф за брак (8%)</p>
                    </div>
                </div>
                
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid #666; cursor: pointer;" onclick="chooseWork('delivery')" class="work-choice-card">
                    <h3 style="color: #4a9eff; margin-bottom: 10px;">🚴 Доставщик еды</h3>
                    <div style="text-align: left; line-height: 1.8; font-size: 0.9em;">
                        <p><strong>💰 Деньги:</strong> 800-1500₽</p>
                        <p><strong>❤️ Здоровье:</strong> -8</p>
                        <p><strong>😴 Усталость:</strong> +15</p>
                        <p><strong>😊 Настроение:</strong> -3</p>
                        <p><strong>🤡 Инцельность:</strong> +4</p>
                        <p><strong>🧠 Адекватность:</strong> +6</p>
                        <hr style="border: 1px solid #333; margin: 10px 0;">
                        <p style="font-size: 0.85em; color: #aaa;"><strong>События:</strong><br>
                        • Чаевые клиента (15%)<br>
                        • Попал под дождь (6%)<br>
                        • Наглая собака (7%)</p>
                    </div>
                </div>
            </div>
            
            <button class="restart-btn" onclick="closeWorkChoice()" style="background: var(--color-secondary); color: var(--color-text); margin-top: 10px;">Отмена</button>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="game-over-modal" id="achievementsModal">
        <div class="game-over-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-color: var(--color-warning);">
            <h2 style="color: var(--color-warning);">🏆 Достижения</h2>
            <div id="achievementsFullList" style="text-align: left; margin: 20px 0;"></div>
            <button class="restart-btn" onclick="closeAchievements()" style="background: var(--color-secondary); color: var(--color-text);">Закрыть</button>
        </div>
    </div>

    <!-- Welcome Toast -->
    <div id="welcome-toast" class="toast hidden">
        <div class="toast-content">
            <div class="toast-icon">🎮</div>
            <div class="toast-text">
                <strong>Добро пожаловать, Матвей!</strong><br>
                День 1. Твоя жизнь начинается сейчас. Удачи в выживании!
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="game-over-modal" id="statisticsModal">
        <div class="game-over-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-color: var(--color-success);">
            <h2 style="color: var(--color-success);">📊 Статистика</h2>
            <div id="statisticsContent" style="text-align: left; margin: 20px 0; line-height: 2;"></div>
            <button class="restart-btn" onclick="closeStatistics()" style="background: var(--color-secondary); color: var(--color-text);">Закрыть</button>
        </div>
    </div>

    <script>
        // ============================================
        // TELEGRAM WEB APP INTEGRATION
        // ============================================
        let tg = null;
        let isTelegram = false;

        // Initialize Telegram Web App
        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                isTelegram = true;
                
                console.log('🚀 Telegram Web App initialized');
                
                // Configure interface
                tg.ready();
                tg.expand(); // Expand to full screen
                
                // Set theme colors
                tg.setHeaderColor('#1a1a1a');
                tg.setBackgroundColor('#1a1a1a');
                
                // Enable closing confirmation
                tg.enableClosingConfirmation();
                
                // Configure Main Button
                tg.MainButton.setText('💾 Сохранить игру');
                tg.MainButton.color = '#4a9eff';
                tg.MainButton.textColor = '#ffffff';
                tg.MainButton.show();
                
                tg.MainButton.onClick(() => {
                    saveGame();
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    tg.showAlert('✅ Игра сохранена в Telegram Cloud!');
                });
                
                // Apply Telegram theme
                document.body.classList.add('telegram');
                if (tg.themeParams) {
                    document.documentElement.style.setProperty('--color-bg', tg.themeParams.bg_color || '#1a1a1a');
                    document.documentElement.style.setProperty('--color-text', tg.themeParams.text_color || '#e0e0e0');
                    document.documentElement.style.setProperty('--color-primary', tg.themeParams.button_color || '#4a9eff');
                }
                
                // Get user info
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    console.log('👤 Telegram User:', user.first_name, user.id);
                }
                
                return true;
            }
            return false;
        }

        // Haptic feedback wrapper
        function hapticFeedback(type = 'light') {
            if (isTelegram && tg && tg.HapticFeedback) {
                if (type === 'light') {
                    tg.HapticFeedback.impactOccurred('light');
                } else if (type === 'medium') {
                    tg.HapticFeedback.impactOccurred('medium');
                } else if (type === 'heavy') {
                    tg.HapticFeedback.impactOccurred('heavy');
                } else if (type === 'success') {
                    tg.HapticFeedback.notificationOccurred('success');
                } else if (type === 'warning') {
                    tg.HapticFeedback.notificationOccurred('warning');
                } else if (type === 'error') {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }

        // Telegram Cloud Storage save
        function saveGame() {
            const saveData = JSON.stringify(gameState);
            
            if (isTelegram && tg && tg.CloudStorage) {
                tg.CloudStorage.setItem('matvey_save', saveData, (error, result) => {
                    if (error) {
                        console.error('❌ Telegram Cloud save error:', error);
                    } else {
                        console.log('☁️ Game saved to Telegram Cloud');
                    }
                });
            } else {
                // Browser mode - use in-memory only (storage blocked in sandbox)
                console.log('💾 Game saved to memory (browser mode)');
            }
        }

        // Throttled save
        let saveTimeout = null;
        function saveGameThrottled() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(() => {
                saveGame();
            }, 1000);
        }

        // Load game from Telegram Cloud
        function loadGameFromTelegram() {
            if (isTelegram && tg && tg.CloudStorage) {
                tg.CloudStorage.getItem('matvey_save', (error, data) => {
                    if (!error && data) {
                        try {
                            gameState = JSON.parse(data);
                            console.log('☁️ Game loaded from Telegram Cloud');
                            updateUI();
                            updateAchievementsDisplay();
                            addLog('<strong>☁️ Прогресс загружен</strong><br>Игра восстановлена из Telegram Cloud!', 'event');
                        } catch (e) {
                            console.error('❌ Parse error:', e);
                            initializeNewGame();
                        }
                    } else {
                        console.log('📝 No save found - new game');
                        initializeNewGame();
                    }
                    updateUI();
                });
            } else {
                console.log('🎮 Browser mode - starting new game');
                initializeNewGame();
                updateUI();
            }
        }

        function initializeNewGame() {
            // gameState already initialized below
            console.log('🎮 New game initialized');
        }

        // Share achievement
        function shareAchievement() {
            if (isTelegram && tg) {
                const message = `🎮 Я выжил ${gameState.day} дней в "Симуляторе Матвея"!\n` +
                               `💰 Заработал: ${gameState.stats.totalMoneyEarned.toLocaleString('ru-RU')}₽\n` +
                               `💖 Отношения с Викой: ${Math.round(gameState.vikaRelationship)}/100\n\n` +
                               `Сможешь ли ты пережить жизнь Матвея?`;
                
                tg.switchInlineQuery(message, ['users', 'groups', 'channels']);
            }
        }

        // ============================================
        // GAME STATE
        // ============================================
        let gameState = {
            health: 100,
            mood: 50,
            satiety: 100,
            adequacy: 20,
            incel: 80,
            godComplex: 40,
            fatigue: 0,
            money: 25000,
            day: 1,
            vikaRelationship: 0,
            parentFoodToday: 0,
            satietyZeroDays: 0,
            daysInDepression: 0,
            daysInDebt: 0,
            hospitalToday: false,
            achievements: [],
            // Statistics tracking
            stats: {
                totalMoneyEarned: 0,
                workShifts: 0,
                vikaCallsSuccess: 0,
                vikaCallsFail: 0,
                vikaMoneySpent: 0,
                postsCount: 0,
                trashMeals: 0,
                dickPics: 0,
                hospitalVisits: 0,
                washCount: 0,
                shaveCount: 0,
                outsideCount: 0,
                daysWithoutOutside: 0,
                suicideAttempts: 0,
                metroRides: 0,
                metroFined: 0
            }
        };

        // Tutorial auto-close flag
        let tutorialClosed = false;

        // Setup action buttons to close tutorial on first click
        function setupTutorialAutoClose() {
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(btn => {
                const originalOnClick = btn.getAttribute('onclick');
                if (originalOnClick) {
                    btn.addEventListener('click', () => {
                        if (!tutorialClosed) {
                            closeTutorial();
                        }
                    }, { once: false });
                }
            });
        }

        // Обновление UI
        function updateUI() {
            // Обновление счетчиков
            document.getElementById('healthValue').textContent = Math.round(gameState.health);
            
            // Display mood (range: 0 to 100)
            const moodValue = Math.round(gameState.mood);
            let moodText = moodValue + '/100';
            if (gameState.mood < 20) {
                if (gameState.daysInDepression === 0) {
                    moodText += ' ⚠️ В депрессии';
                } else if (gameState.daysInDepression === 1) {
                    moodText += ' ⚠️ Депрессия: 1/3';
                } else if (gameState.daysInDepression === 2) {
                    moodText += ' ⚠️ ОПАСНО! 2/3';
                }
            }
            document.getElementById('moodValue').textContent = moodText;
            document.getElementById('satietyValue').textContent = Math.round(gameState.satiety);
            document.getElementById('adequacyValue').textContent = Math.round(gameState.adequacy);
            document.getElementById('incelValue').textContent = Math.round(gameState.incel);
            document.getElementById('godComplexValue').textContent = Math.round(gameState.godComplex);
            document.getElementById('fatigueValue').textContent = Math.round(gameState.fatigue);
            // Update money display with debt indication
            const moneyDisplay = document.getElementById('moneyDisplay');
            const moneyValue = document.getElementById('moneyValue');
            const debtCounter = document.getElementById('debtCounter');
            const debtDays = document.getElementById('debtDays');
            
            if (gameState.money < 0) {
                moneyDisplay.classList.add('debt');
                moneyValue.textContent = gameState.money.toLocaleString('ru-RU');
                moneyValue.innerHTML = gameState.money.toLocaleString('ru-RU') + ' ⚠️ ДОЛГ!';
                debtCounter.style.display = 'block';
                debtDays.textContent = gameState.daysInDebt;
                if (gameState.daysInDebt >= 6) {
                    debtCounter.classList.add('critical');
                } else {
                    debtCounter.classList.remove('critical');
                }
            } else {
                moneyDisplay.classList.remove('debt');
                moneyValue.textContent = gameState.money.toLocaleString('ru-RU');
                debtCounter.style.display = 'none';
            }
            document.getElementById('dayCounter').textContent = gameState.day;
            document.getElementById('vikaRelationshipValue').textContent = Math.round(gameState.vikaRelationship) + '/100';
            document.getElementById('vikaRelationshipBar').style.width = gameState.vikaRelationship + '%';

            // Обновление прогресс-баров
            document.getElementById('healthBar').style.width = gameState.health + '%';
            
            // Mood bar: 0-100 range
            const moodBar = document.getElementById('moodBar');
            moodBar.style.width = gameState.mood + '%';
            
            // Update mood bar color based on mood value
            if (gameState.mood < 20) {
                moodBar.className = 'progress-fill progress-mood-red';
            } else if (gameState.mood <= 40) {
                moodBar.className = 'progress-fill progress-mood-orange';
            } else if (gameState.mood <= 70) {
                moodBar.className = 'progress-fill progress-mood-yellow';
            } else {
                moodBar.className = 'progress-fill progress-mood-green';
            }
            document.getElementById('satietyBar').style.width = gameState.satiety + '%';
            document.getElementById('adequacyBar').style.width = gameState.adequacy + '%';
            document.getElementById('incelBar').style.width = gameState.incel + '%';
            document.getElementById('godComplexBar').style.width = gameState.godComplex + '%';
            
            // Update fatigue bar with color based on level
            const fatigueBar = document.getElementById('fatigueBar');
            fatigueBar.style.width = gameState.fatigue + '%';
            if (gameState.fatigue <= 30) {
                fatigueBar.className = 'progress-fill progress-fatigue-low';
            } else if (gameState.fatigue <= 60) {
                fatigueBar.className = 'progress-fill progress-fatigue-medium';
            } else {
                fatigueBar.className = 'progress-fill progress-fatigue-high';
            }

            // Предупреждения о критических значениях
            updateStatAlerts();
            updateActionButtons();
        }

        function updateStatAlerts() {
            const healthValue = document.getElementById('healthValue');
            const satietyValue = document.getElementById('satietyValue');
            const godComplexValue = document.getElementById('godComplexValue');
            const moodValue = document.getElementById('moodValue');

            healthValue.className = gameState.health <= 20 ? 'stat-value stat-alert' : 'stat-value';
            satietyValue.className = gameState.satiety <= 20 ? 'stat-value stat-alert' : 'stat-value';
            godComplexValue.className = gameState.godComplex >= 70 ? 'stat-value stat-alert' : 'stat-value';
            moodValue.className = gameState.mood < 20 ? 'stat-value stat-alert' : 'stat-value';
            
            const adequacyValue = document.getElementById('adequacyValue');
            adequacyValue.className = gameState.adequacy < 20 ? 'stat-value stat-alert' : 'stat-value';
            
            const fatigueValue = document.getElementById('fatigueValue');
            fatigueValue.className = gameState.fatigue >= 80 ? 'stat-value stat-alert' : 'stat-value';
        }

        function updateActionButtons() {
            // Кнопка работы
            const workBtn = document.querySelector('[onclick="work()"]');
            if (gameState.fatigue >= 80) {
                workBtn.disabled = true;
                workBtn.setAttribute('data-tooltip', '❌ Слишком устал для работы (усталость ' + Math.round(gameState.fatigue) + '/100)');
            } else if (gameState.godComplex > 50) {
                workBtn.disabled = true;
                workBtn.setAttribute('data-tooltip', '❌ Я слишком крут для работы (комплекс бога ' + Math.round(gameState.godComplex) + '/100)');
            } else {
                workBtn.disabled = false;
                workBtn.setAttribute('data-tooltip', 'Выбери: Асфальт (тяжело, 2200-3800₽) или Доставка (легче, 800-1500₽)');
            }
            
            // Кнопки, блокируемые комплексом бога
            const washBtn = document.querySelector('[onclick="wash()"]');
            const shaveBtn = document.querySelector('[onclick="shave()"]');
            const goOutsideBtn = document.getElementById('goOutsideBtn');
            
            // Кнопка мытья
            if (gameState.godComplex > 50) {
                washBtn.disabled = true;
                washBtn.setAttribute('data-tooltip', '❌ Я слишком крут, чтобы мыться (комплекс бога ' + Math.round(gameState.godComplex) + '/100)');
            } else {
                washBtn.disabled = false;
                washBtn.setAttribute('data-tooltip', '🧠 +8 адекватности | 🔻 -8 инцельности | 😴 +6 | (25% шанс: 📸 сфоткать пенис)');
            }
            
            // Кнопка бритья
            if (gameState.godComplex > 50) {
                shaveBtn.disabled = true;
                shaveBtn.setAttribute('data-tooltip', '❌ Мне не нужно следить за собой (комплекс бога ' + Math.round(gameState.godComplex) + '/100)');
            } else {
                shaveBtn.disabled = false;
                shaveBtn.setAttribute('data-tooltip', '🧠 +7 адекватности | 🔻 -7 инцельности | 😴 +4 | (35% шанс: 🤳 селфи)');
            }
            
            // Кнопка выхода из дома
            if (gameState.godComplex > 50) {
                goOutsideBtn.disabled = true;
                goOutsideBtn.setAttribute('data-tooltip', '❌ Они недостойны меня видеть (комплекс бога ' + Math.round(gameState.godComplex) + '/100)');
            } else if (gameState.fatigue >= 80) {
                goOutsideBtn.disabled = true;
                goOutsideBtn.setAttribute('data-tooltip', '❌ Слишком устал для прогулки (усталость ' + Math.round(gameState.fatigue) + '/100)');
            } else {
                goOutsideBtn.disabled = false;
                goOutsideBtn.setAttribute('data-tooltip', '🧠 +8 адекватности | 😴 +18 усталости | 😊 +3 настроения');
            }
            
            // Кнопка еды от родителей
            const askFoodBtn = document.getElementById('askFoodBtn');
            if (gameState.parentFoodToday >= 3) {
                askFoodBtn.disabled = true;
                askFoodBtn.setAttribute('data-tooltip', '❌ Родители уже не дадут еды сегодня (лимит 3)');
            } else {
                askFoodBtn.disabled = false;
                askFoodBtn.setAttribute('data-tooltip', '🍔 +35 сытости | 😊 -8 настроения | Осталось: ' + (3 - gameState.parentFoodToday) + '/3');
            }
            
            // Кнопка звонка Вике
            const callVikaBtn = document.getElementById('callVikaBtn');
            // Calculate dynamic success chance for tooltip
            const baseChance = 75;
            const incelPenalty = (gameState.incel - 50) * 0.5;
            const godComplexPenalty = (gameState.godComplex - 40) * 0.3;
            let successChance = baseChance - incelPenalty - godComplexPenalty;
            successChance = Math.max(5, Math.min(95, successChance));
            
            if (gameState.adequacy < 35) {
                callVikaBtn.disabled = true;
                callVikaBtn.setAttribute('data-tooltip', '❌ Недостаточно адекватности (нужно 35+, есть ' + Math.round(gameState.adequacy) + ')');
            } else if (gameState.money < 10000) {
                callVikaBtn.disabled = true;
                callVikaBtn.setAttribute('data-tooltip', '❌ Недостаточно денег (нужно 10000₽)');
            } else {
                callVikaBtn.disabled = false;
                callVikaBtn.setAttribute('data-tooltip', '💰 -10000₽ | 🧠 требует 35+ адекватности | 😴 +20 | Шанс: ' + Math.round(successChance) + '%');
            }
            
            // Кнопка постинга в АЯЕЧ
            const postBtn = document.getElementById('postBtn');
            if (gameState.fatigue >= 80) {
                postBtn.disabled = true;
                postBtn.setAttribute('data-tooltip', '❌ Слишком устал для постинга (усталость ' + Math.round(gameState.fatigue) + '/100)');
            } else {
                postBtn.disabled = false;
                postBtn.setAttribute('data-tooltip', '😊 +8 настроения | 📈 +8 инцельности | 😴 +12 усталости');
            }
            
            // Кнопка Мамбы
            const mambaBtn = document.getElementById('mambaBtn');
            if (gameState.money < 8000) {
                mambaBtn.disabled = true;
                mambaBtn.setAttribute('data-tooltip', '❌ Недостаточно денег (нужно 8000₽)');
            } else {
                mambaBtn.disabled = false;
                mambaBtn.setAttribute('data-tooltip', '💰 -8000₽ | 😊 +35 настроения | ❤️ -18 здоровья | 😴 +10 усталости');
            }
            
            // Кнопка больницы
            const hospitalBtn = document.getElementById('hospitalBtn');
            if (gameState.hospitalToday) {
                hospitalBtn.disabled = true;
                hospitalBtn.setAttribute('data-tooltip', '❌ Уже был в больнице сегодня');
            } else if (gameState.money < 2000) {
                hospitalBtn.disabled = true;
                hospitalBtn.setAttribute('data-tooltip', '❌ Недостаточно денег (нужно 2000₽)');
            } else {
                hospitalBtn.disabled = false;
                hospitalBtn.setAttribute('data-tooltip', '❤️ +25 здоровья | 💰 -2000₽ | 😴 +20 | 😊 -12 | 🧠 +5 | 1 раз/день');
            }
            
            // Кнопка дрочки
            const masturbateBtn = document.querySelector('[onclick="masturbate()"]');
            if (gameState.fatigue >= 80) {
                masturbateBtn.disabled = true;
                masturbateBtn.setAttribute('data-tooltip', '❌ Слишком устал даже для этого (усталость ' + Math.round(gameState.fatigue) + '/100)');
            } else {
                masturbateBtn.disabled = false;
                masturbateBtn.setAttribute('data-tooltip', '😊 +8 настроения | ❤️ +2 здоровья | 📈 +10 инцельности | 🧠 -10 адекватности | 😴 +7 усталости | Блокируется при усталости ≥80');
            }
            
            // Кнопка метро
            const metroBtn = document.getElementById('metroBtn');
            if (gameState.money < 50) {
                metroBtn.disabled = true;
                metroBtn.setAttribute('data-tooltip', '❌ Недостаточно денег (нужно 50₽)');
            } else if (gameState.fatigue >= 80) {
                metroBtn.disabled = true;
                metroBtn.setAttribute('data-tooltip', '❌ Слишком устал для поездки (усталость ' + Math.round(gameState.fatigue) + '/100)');
            } else {
                metroBtn.disabled = false;
                metroBtn.setAttribute('data-tooltip', '👑 -25 комплекса бога | 📈 +18 инцельности | 😴 +15 | 💰 -50₽ | 😊 +3 | 🧠 -3');
            }
        }

        // Логирование событий
        function addLog(message, type = 'normal') {
            const log = document.getElementById('eventLog');
            if (!log) {
                console.error('Event log container not found!');
                return;
            }
            
            // Создать новое сообщение
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.innerHTML = message;
            
            // Добавить В НАЧАЛО (новые события сверху)
            if (log.firstChild) {
                log.insertBefore(entry, log.firstChild);
            } else {
                log.appendChild(entry);
            }
            
            // Ограничение количества записей (max 50)
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // Изменение параметра с ограничением
        function changeStat(stat, amount) {
            // CRITICAL: All stats are 0-100, including MOOD (not 50-100!)
            gameState[stat] += amount;
            gameState[stat] = Math.max(0, Math.min(100, gameState[stat]));
            
            // Alert when fatigue gets too high
            if (stat === 'fatigue' && gameState.fatigue >= 80 && gameState.fatigue - amount < 80) {
                addLog(`<strong>⚠️ Усталость критична!</strong><br>Матвей совсем обессилен. Пора спать.`, 'danger');
            }
            
            // Инверсная связь адекватности и инцельности
            if (stat === 'adequacy') {
                gameState.incel = Math.max(0, Math.min(100, 100 - gameState.adequacy));
            } else if (stat === 'incel') {
                gameState.adequacy = Math.max(0, Math.min(100, 100 - gameState.incel));
            }
        }

        // Действия игрока
        function work() {
            if (gameState.fatigue >= 80) {
                addLog(`<strong>Работа</strong><br>Слишком устал для этого действия. Нужно поспать.`, 'danger');
                return;
            }
            
            if (gameState.godComplex > 50) {
                addLog(`<strong>Работа</strong><br>❌ Я слишком крут для работы! Комплекс бога слишком высок.`, 'danger');
                return;
            }
            
            // Show work choice modal
            document.getElementById('workChoiceModal').style.display = 'flex';
        }

        function closeWorkChoice() {
            document.getElementById('workChoiceModal').style.display = 'none';
        }

        function chooseWork(type) {
            closeWorkChoice();
            hapticFeedback('light');
            
            if (type === 'asphalt') {
                workAsphalt();
            } else if (type === 'delivery') {
                workDelivery();
            }
        }

        function workAsphalt() {
            const salary = Math.floor(Math.random() * (3800 - 2200 + 1)) + 2200;  // Rebalanced: 2200-3800
            
            changeStat('health', -15);  // Increased from -13
            changeStat('mood', -8);  // Increased from -7
            changeStat('fatigue', 25);  // Increased from 20
            changeStat('incel', 8);  // Increased from 7
            changeStat('adequacy', 3);  // Decreased from 5
            gameState.money += salary;
            gameState.stats.workShifts++;
            gameState.stats.totalMoneyEarned += salary;
            
            let logText = `<strong>🚧 Работа укладчиком асфальта</strong><br>Матвей провел тяжелую смену на стройке. Заработал ${salary.toLocaleString('ru-RU')}₽. -13 здоровья, -7 настроения, +20 усталости, +7 инцельности, +5 адекватности.`;
            
            // Random events
            const rand = Math.random() * 100;
            if (rand < 12) {
                // Scandal with colleagues (12%)
                changeStat('mood', -13);
                changeStat('incel', 12);
                logText += `<br><span style="color: #ff4444;">😠 Скандал с коллегами! Начальник орал на всех. -13 настроения, +12 инцельности</span>`;
            } else if (rand < 18) {
                // Boss praised (6%)
                changeStat('mood', 15);
                gameState.money += 600;
                gameState.stats.totalMoneyEarned += 600;
                logText += `<br><span style="color: #44ff44;">🎉 Рано закончили смену, начальник похвалил! +15 настроения, +600₽</span>`;
            } else if (rand < 26) {
                // Fine for defect (8%)
                gameState.money -= 900;
                gameState.money = Math.max(0, gameState.money);
                changeStat('adequacy', -5);
                changeStat('mood', -6);
                logText += `<br><span style="color: #ff4444;">⚠️ Асфальт не засох — штраф за брак! -900₽, -5 адекватности, -6 настроения</span>`;
            }
            
            addLog(logText);
            hapticFeedback('medium');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
            checkGameOver();
        }

        function workDelivery() {
            const salary = Math.floor(Math.random() * (1500 - 800 + 1)) + 800;  // Rebalanced: 800-1500
            
            changeStat('health', -8);  // Increased from -7
            changeStat('mood', -3);  // Increased from -2
            changeStat('fatigue', 15);  // Increased from 12
            changeStat('incel', 4);  // Increased from 3
            changeStat('adequacy', 6);  // Decreased from 7
            gameState.money += salary;
            gameState.stats.workShifts++;
            gameState.stats.totalMoneyEarned += salary;
            
            let logText = `<strong>🚴 Работа доставщиком еды</strong><br>Матвей отработал смену на доставке. Заработал ${salary.toLocaleString('ru-RU')}₽. -7 здоровья, -2 настроения, +12 усталости, +3 инцельности, +7 адекватности.`;
            
            // Random events
            const rand = Math.random() * 100;
            if (rand < 15) {
                // Tips (15%)
                gameState.money += 200;
                gameState.stats.totalMoneyEarned += 200;
                changeStat('mood', 6);
                logText += `<br><span style="color: #44ff44;">💵 Клиент оставил чаевые! +200₽, +6 настроения</span>`;
            } else if (rand < 21) {
                // Rain (6%)
                changeStat('health', -11);
                changeStat('mood', -7);
                logText += `<br><span style="color: #4a9eff;">🌧️ Попал под дождь! Промок насквозь. -11 здоровья, -7 настроения</span>`;
            } else if (rand < 28) {
                // Dog (7%)
                changeStat('incel', 9);
                changeStat('mood', -5);
                logText += `<br><span style="color: #ffaa00;">🐕 Наглая собака! Чуть не укусила за ногу. -5 настроения, +9 инцельности</span>`;
            }
            
            addLog(logText);
            hapticFeedback('medium');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
            checkGameOver();
        }

        function wash() {
            if (gameState.godComplex > 50) {
                addLog(`<strong>Помыться</strong><br>❌ Я слишком крут, чтобы мыться! Комплекс бога слишком высок.`, 'danger');
                return;
            }
            
            changeStat('adequacy', 8);  // Decreased from 10
            changeStat('fatigue', 6);  // Increased from 5
            gameState.stats.washCount++;
            
            // 25% chance for dick pic event (decreased from 30%)
            if (Math.random() < 0.25) {
                const dickPicTexts = [
                    'Пока мылся, Матвей сфоткал свой член и запостил в АЯЕЧ. Получил несколько лайков от других инцелов.',
                    'Матвей решил запечатлеть свое достоинство и выложить фото. Комплексы немного отступили.'
                ];
                const eventText = dickPicTexts[Math.floor(Math.random() * dickPicTexts.length)];
                
                changeStat('mood', 12);  // Decreased from 15
                changeStat('godComplex', 12);  // Increased from 10
                changeStat('adequacy', -20); // This makes total adequacy effect: +8-20 = -12
                gameState.stats.dickPics++;
                
                addLog(`<strong>📸🍆 Помылся + Сфоткал пенис!</strong><br>${eventText}<br>Итого: -12 адекватности, -8 инцельности, +6 усталости, +12 настроения, +12 комплекса бога.`, 'event');
            } else {
                addLog(`<strong>Помылся</strong><br>Ты принял душ. Чувствуешь себя почти человеком. +8 адекватности, -8 инцельности, +6 усталости.`);
            }
            
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
        }

        function shave() {
            if (gameState.godComplex > 50) {
                addLog(`<strong>Побриться</strong><br>❌ Мне не нужно следить за собой! Комплекс бога слишком высок.`, 'danger');
                return;
            }
            
            changeStat('adequacy', 7);  // Decreased from 8
            changeStat('fatigue', 4);  // Increased from 3
            gameState.stats.shaveCount++;
            
            // 35% chance for selfie event (decreased from 40%)
            if (Math.random() < 0.35) {
                const selfieTexts = [
                    'Побрившись, Матвей сделал селфи. Выглядит неплохо! Даже получил комплимент в конфе.',
                    'После бритья Матвей почувствовал себя увереннее. Селфи вышло удачным.'
                ];
                const eventText = selfieTexts[Math.floor(Math.random() * selfieTexts.length)];
                
                changeStat('mood', 10);  // Decreased from 12
                changeStat('adequacy', 6); // This makes total adequacy effect: +7+6 = +13
                
                addLog(`<strong>🤳 Побрился + Селфи!</strong><br>${eventText}<br>Итого: +13 адекватности, -7 инцельности, +4 усталости, +10 настроения.`, 'event');
            } else {
                addLog(`<strong>Побрился</strong><br>Ты избавился от щетины. Выглядишь чуть приличнее. +7 адекватности, -7 инцельности, +4 усталости.`);
            }
            
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
        }

        function goOutside() {
            if (gameState.godComplex > 50) {
                addLog(`<strong>Выход из дома</strong><br>❌ Они недостойны меня видеть! Комплекс бога слишком высок.`, 'danger');
                return;
            }
            
            if (gameState.fatigue >= 80) {
                addLog(`<strong>Выход из дома</strong><br>Слишком устал для этого действия. Нужно поспать.`, 'danger');
                return;
            }
            
            changeStat('adequacy', 8);  // Increased from 5
            changeStat('fatigue', 18);  // Increased from 15
            changeStat('mood', 3);  // New addition
            gameState.stats.outsideCount++;
            gameState.stats.daysWithoutOutside = 0;
            
            let logText = `<strong>Выход из дома</strong><br>Прогулялся по Питеру. +8 адекватности, +18 усталости, +3 настроения.`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.05) {
                // Found money (5%)
                gameState.money += 200;
                logText += `<br><span style="color: #44ff44;">💰 Нашел 200₽ на земле!</span>`;
            } else if (rand < 0.15) {
                // Met friend (10%)
                changeStat('mood', 15);
                changeStat('adequacy', 10);
                logText += `<br><span style="color: #4a9eff;">👋 Встретил старого друга! +15 настроения, +10 адекватности</span>`;
            } else if (rand < 0.30) {
                // Saw couple (15%)
                changeStat('mood', -15);
                changeStat('incel', 10);
                logText += `<br><span style="color: #ff4444;">💔 Увидел счастливую пару... -15 настроения, +10 инцельности</span>`;
            }
            
            addLog(logText);
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
        }

        function askParentsFood() {
            if (gameState.parentFoodToday >= 3) {
                addLog(`<strong>Еда от родителей</strong><br>Родители устали от твоих просьб сегодня. Попробуй завтра.`, 'danger');
                return;
            }
            
            changeStat('satiety', 35);  // Increased from 30
            changeStat('mood', -8);  // Increased penalty from -5
            gameState.parentFoodToday++;
            
            let logText = `<strong>Еда от родителей</strong><br>`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.15) {
                // Father gives money (15%)
                gameState.money += 1000;
                changeStat('godComplex', -5);
                logText += `Отец дал 1000₽ и еду. +35 сытости, -8 настроения, -5 комплекса бога.`;
                logText += `<br><span style="color: #4a9eff;">💰 Отец подкинул денег из жалости</span>`;
            } else if (rand < 0.35) {
                // Mother scolds (20%)
                changeStat('mood', -10); // -5 base + -10 extra = -15 total
                changeStat('incel', 10);
                logText += `Мать отчитала за тунеядство. +35 сытости, -18 настроения, +10 инцельности.`;
                logText += `<br><span style="color: #ff4444;">😤 "Когда же ты найдешь нормальную работу?!"</span>`;
            } else {
                const responses = [
                    'Мама с укоризной дала тебе макароны с сосиской.',
                    'Отец молча передал тебе контейнер с едой.',
                    'Родители накормили, но стыд тебя гложет.'
                ];
                logText += `${responses[Math.floor(Math.random() * responses.length)]} +35 сытости, -8 настроения.`;
            }
            
            logText += ` Осталось попыток сегодня: ${3 - gameState.parentFoodToday}`;
            addLog(logText);
            hapticFeedback('light');
            saveGameThrottled();
            updateUI();
        }

        function eatTrash() {
            changeStat('satiety', 25);  // Decreased from 30
            changeStat('incel', 15);  // Increased from 10
            changeStat('health', -8);  // Increased from -5
            changeStat('adequacy', -5);  // New penalty
            gameState.stats.trashMeals++;
            
            const events = [
                'Нашёл почти свежий пирожок в помойке за магазином.',
                'Достал из контейнера недоеденную шаурму. Вкус странный, но сойдёт.',
                'Раскопал в мусорке хлеб. Плесень обрезал.'
            ];
            
            addLog(`<strong>Помойка</strong><br>${events[Math.floor(Math.random() * events.length)]} +25 сытости, +15 инцельности, -8 здоровья, -5 адекватности.`, 'event');
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
            checkGameOver();
        }

        function callVika() {
            if (gameState.adequacy < 35) {
                addLog(`<strong>Звонок Вике</strong><br>Ты слишком неадекватен для этого. Нужно хотя бы 35 адекватности.`, 'danger');
                return;
            }
            
            if (gameState.money < 10000) {
                addLog(`<strong>Звонок Вике</strong><br>У тебя нет 10,000₽ на эту авантюру.`, 'danger');
                return;
            }
            
            // Calculate dynamic success chance
            const baseChance = 75;
            const incelPenalty = (gameState.incel - 50) * 0.5;
            const godComplexPenalty = (gameState.godComplex - 40) * 0.3;
            let successChance = baseChance - incelPenalty - godComplexPenalty;
            successChance = Math.max(5, Math.min(95, successChance));
            
            // CRITICAL: Decrease money (can go negative!)
            gameState.money -= 10000;
            gameState.stats.vikaMoneySpent += 10000;
            changeStat('fatigue', 20);
            
            addLog(`<strong>Звонок Вике</strong><br>Попытка позвонить Вике... (шанс успеха: ${Math.round(successChance)}%)`, 'event');
            
            if (Math.random() * 100 < successChance) {
                // Успех
                changeStat('mood', 30);
                changeStat('health', 10);
                changeStat('godComplex', 5);
                gameState.vikaRelationship = Math.min(100, gameState.vikaRelationship + 10);
                gameState.stats.vikaCallsSuccess++;
                
                let vikaText = `<strong>Звонок Вике ✅</strong><br>Неожиданно, но Вика согласилась встретиться! Вы провели отличный вечер. +30 настроения, +10 здоровья, +5 комплекса бога, +20 усталости, +10 отношений с Викой. -10,000₽`;
                
                if (gameState.vikaRelationship >= 100) {
                    vikaText += `<br><br><span style="color: #ff1493; font-size: 1.2em;">💖💖💖 МАКСИМАЛЬНЫЕ ОТНОШЕНИЯ! 💖💖💖</span><br>Вика влюбилась в Матвея! Возможна хорошая концовка...`;
                }
                
                addLog(vikaText, 'event');
            } else {
                // Провал
                changeStat('mood', -40);
                changeStat('incel', 20);
                changeStat('godComplex', -10);
                gameState.vikaRelationship = Math.max(0, gameState.vikaRelationship - 15);
                gameState.stats.vikaCallsFail++;
                addLog(`<strong>Звонок Вике ❌</strong><br>Вика послала тебя куда подальше. Деньги потрачены впустую. -40 настроения, +20 инцельности, -10 комплекса бога, +20 усталости, -15 отношений с Викой. -10,000₽`, 'danger');
            }
            
            checkAchievementsProgress();
            updateUI();
            checkGameOver();
        }

        function postAyaech() {
            if (gameState.fatigue >= 80) {
                addLog(`<strong>АЯЕЧ</strong><br>Слишком устал для этого действия. Нужно поспать.`, 'danger');
                return;
            }
            
            changeStat('mood', 8);  // Decreased from 10
            changeStat('incel', 8);  // Increased from 5
            changeStat('fatigue', 12);  // Increased from 10
            gameState.stats.postsCount++;
            
            let logText = `<strong>АЯЕЧ</strong><br>Запостил в АЯЕЧ. +8 настроения, +8 инцельности, +12 усталости.`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.25) {
                // Viral post (25%)
                changeStat('mood', 15); // +10 base + 15 = +25 total
                changeStat('godComplex', 10);
                logText += `<br><span style="color: #44ff44;">🔥 Пост набрал много лайков! +15 настроения, +10 комплекса бога</span>`;
            } else if (rand < 0.40) {
                // Banned (15%)
                changeStat('mood', -20); // +10 base - 20 = -10 total
                changeStat('incel', 15); // +5 base + 15 = +20 total
                logText += `<br><span style="color: #ff4444;">🚫 Тебя забанили на день! -20 настроения, +15 инцельности</span>`;
            }
            
            addLog(logText);
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
        }

        function masturbate() {
            // НОВАЯ ПРОВЕРКА: блокировка при усталости ≥80
            if (gameState.fatigue >= 80) {
                addLog(`<strong>Дрочка</strong><br>❌ Слишком устал даже для этого...`, 'danger');
                return;
            }
            
            changeStat('mood', 8);  // Decreased from 10
            changeStat('health', 2);
            changeStat('incel', 10);  // Increased from 8
            changeStat('adequacy', -10);  // Increased penalty from -8
            changeStat('fatigue', 7);  // Increased from 5
            
            let logText = `<strong>Дрочка</strong><br>Матвей подрочил. +8 настроения, +2 здоровья, +10 инцельности, -10 адекватности, +7 усталости.`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.10) {
                // Perfect video (10%)
                changeStat('mood', 5);
                logText += `<br><span style="color: #44ff44;">😍 Нашел идеальное видео! +5 настроения</span>`;
            } else if (rand < 0.25) {
                // Almost caught (15%)
                changeStat('mood', -15);
                changeStat('incel', 10);
                logText += `<br><span style="color: #ff4444;">😱 Родители чуть не застукали! -15 настроения, +10 инцельности</span>`;
            }
            
            addLog(logText);
            hapticFeedback('light');
            saveGameThrottled();
            updateUI();
        }

        function orderMamba() {
            if (gameState.money < 8000) {
                addLog(`<strong>Мамба</strong><br>У тебя нет 8,000₽ на эту дрянь.`, 'danger');
                return;
            }
            
            // CRITICAL: Decrease money (can go negative!)
            gameState.money -= 8000;
            changeStat('mood', 35);  // Decreased from 40
            changeStat('health', -18);  // Increased from -15
            changeStat('fatigue', 10);  // New penalty
            
            let logText = `<strong>Мамба заказана</strong><br>Ты заказал синтетику. +35 настроения, -18 здоровья, +10 усталости. -8,000₽`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.20) {
                // Catfish (20%)
                changeStat('mood', -30); // +35 base - 30 = +5 total
                changeStat('incel', 20);
                changeStat('godComplex', 15);
                logText += `<br><span style="color: #ff4444;">😱 Мамба оказалась МУЖИКОМ! Какой кошмар! -30 настроения, +20 инцельности, +15 комплекса бога</span>`;
            } else if (rand < 0.30) {
                // Great evening (10%)
                changeStat('mood', 20); // +35 + 20 = +55 total
                changeStat('incel', -10);
                logText += `<br><span style="color: #44ff44;">💚 Отличный вечер! Мамба была огонь! +20 настроения, -10 инцельности</span>`;
            }
            
            addLog(logText, 'event');
            hapticFeedback('medium');
            saveGameThrottled();
            updateUI();
            checkGameOver();
        }
        
        function goToHospital() {
            if (gameState.hospitalToday) {
                addLog(`<strong>Больница</strong><br>Уже был в больнице сегодня. Завтра приходи.`, 'danger');
                return;
            }
            
            if (gameState.money < 2000) {
                addLog(`<strong>Больница</strong><br>Недостаточно денег (нужно 2000₽).`, 'danger');
                return;
            }
            
            // CRITICAL: Decrease money (can go negative!)
            gameState.money -= 2000;
            changeStat('health', 25);
            changeStat('fatigue', 20);  // Increased from 15
            changeStat('mood', -12);  // Increased penalty from -10
            changeStat('adequacy', 5);
            gameState.hospitalToday = true;
            gameState.stats.hospitalVisits++;
            
            let logText = `<strong>🏥 Больница</strong><br>Матвей сходил в поликлинику. +25 здоровья, -10 настроения, +15 усталости, +5 адекватности. -2,000₽`;
            
            // Random events
            const rand = Math.random();
            if (rand < 0.20) {
                // Young doctor (20%)
                changeStat('mood', 10); // -10 base + 10 = 0 total
                changeStat('incel', -5);
                logText += `<br><span style="color: #4a9eff;">💉 Попалась молодая врач! +10 настроения, -5 инцельности</span>`;
            } else if (rand < 0.30) {
                // Found issues (10%)
                changeStat('mood', -10); // -10 base - 10 = -20 total
                logText += `<br><span style="color: #ff4444;">⚠️ Обнаружили проблемы со здоровьем... -10 настроения</span>`;
            }
            
            addLog(logText);
            hapticFeedback('light');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
        }

        function rideMetro() {
            if (gameState.money < 50) {
                addLog(`<strong>Метро</strong><br>Недостаточно денег на проезд (нужно 50₽).`, 'danger');
                return;
            }
            
            if (gameState.fatigue >= 80) {
                addLog(`<strong>Метро</strong><br>Слишком устал для поездки. Нужно поспать.`, 'danger');
                return;
            }
            
            // Base effects - can go into debt!
            gameState.money -= 50;
            changeStat('godComplex', -25);
            changeStat('incel', 18);  // Decreased from 20
            changeStat('fatigue', 15);
            changeStat('mood', 3);  // Decreased from 5
            changeStat('adequacy', -3);  // Decreased penalty from -5
            gameState.stats.metroRides++;
            
            let logText = `<strong>🚇 Метро</strong><br>Матвей прокатился по петербургскому метро среди обычных людей. Реальность напомнила о себе. -25 комплекса бога, +18 инцельности, +15 усталости, +3 настроения, -3 адекватности. -50₽`;
            
            // Random events (total ~50% chance, but each event is rare)
            const rand = Math.random() * 100;
            
            if (rand < 8) {
                // CRITICAL FIX: Alternative punishment when no money
                const fine = 3000;
                if (gameState.money >= fine) {
                    // Has money - pay fine normally
                    gameState.money -= fine;
                    changeStat('mood', -15);
                    changeStat('incel', 15);
                    gameState.stats.metroFined++;
                    logText += `<br><span style="color: #ff4444;">🚨 Попался контролерам без билета! Выписали штраф 3000₽. Позор... -15 настроения, +15 инцельности</span>`;
                } else {
                    // No money - psychological damage and debt
                    gameState.money -= fine;  // Goes into debt!
                    changeStat('mood', -30);  // Double penalty
                    changeStat('health', -15);  // Extra damage
                    changeStat('incel', 25);  // More incel
                    gameState.stats.metroFined++;
                    logText += `<br><span style="color: #ff4444;">🚨 Контролеры! Нет денег на штраф. Позор и депрессия... -30 настроения, -15 здоровья, +25 инцельности. Долг: ${gameState.money.toLocaleString('ru-RU')}₽</span>`;
                }
            } else if (rand < 20) {
                // Красивая девушка (12%)
                changeStat('mood', -20);
                changeStat('incel', 15);
                changeStat('godComplex', -10);
                logText += `<br><span style="color: #ff4444;">💔 В вагоне ехала красивая девушка. Она даже не посмотрела в сторону Матвея. Больно... -20 настроения, +15 инцельности, -10 комплекса бога</span>`;
            } else if (rand < 30) {
                // Попрошайка (10%)
                if (Math.random() < 0.5) {
                    // Дал денег (can go negative)
                    gameState.money -= 100;
                    changeStat('mood', 10);
                    changeStat('incel', -5);
                    changeStat('godComplex', -10);
                    logText += `<br><span style="color: #4a9eff;">🙏 Попрошайка просил денег. Матвей дал ему 100₽. +10 настроения, -5 инцельности, -10 комплекса бога</span>`;
                } else {
                    // Не дал
                    changeStat('mood', 5);
                    changeStat('incel', 10);
                    changeStat('godComplex', 5);
                    logText += `<br><span style="color: #ffaa00;">💰 Попрошайка просил денег. Матвей прошел мимо. +5 настроения, +10 инцельности, +5 комплекса бога</span>`;
                }
            } else if (rand < 35) {
                // Драка в метро (5%)
                changeStat('health', -15);
                changeStat('mood', -10);
                changeStat('incel', 20);
                changeStat('godComplex', -15);
                logText += `<br><span style="color: #ff4444;">💥 В вагоне произошла драка, и Матвей случайно получил по лицу. Реальность бьет больно. -15 здоровья, -10 настроения, +20 инцельности, -15 комплекса бога</span>`;
            } else if (rand < 42) {
                // Интересный разговор (7%)
                changeStat('mood', 15);
                changeStat('adequacy', 10);
                changeStat('godComplex', -10);
                changeStat('incel', -10);
                logText += `<br><span style="color: #44ff44;">💬 Матвей случайно услышал интересный разговор. Немного вернулась вера в людей. +15 настроения, +10 адекватности, -10 комплекса бога, -10 инцельности</span>`;
            } else if (rand < 50) {
                // Бомжи в переходе (8%)
                changeStat('mood', -5);
                changeStat('adequacy', 5);
                changeStat('godComplex', -10);
                logText += `<br><span style="color: #ffaa00;">🏚️ Видел бомжей в переходе. Понял, что его жизнь еще не так плоха. -5 настроения, +5 адекватности, -10 комплекса бога</span>`;
            }
            
            addLog(logText, 'event');
            hapticFeedback('medium');
            saveGameThrottled();
            checkAchievementsProgress();
            updateUI();
            checkGameOver();
        }

        // Сон и переход на следующий день
        function sleep() {
            // CRITICAL: Day degradation happens HERE
            gameState.day++;
            gameState.parentFoodToday = 0;
            gameState.hospitalToday = false;
            gameState.stats.daysWithoutOutside++;
            
            // Track debt days
            if (gameState.money < 0) {
                gameState.daysInDebt++;
                gameState.stats.wasInDebt = true;
                if (gameState.daysInDebt > gameState.stats.maxDebtDays) {
                    gameState.stats.maxDebtDays = gameState.daysInDebt;
                }
            } else {
                gameState.daysInDebt = 0; // Reset if positive balance
            }
            
            // DEGRADATION - stats decrease daily (REBALANCED)
            changeStat('health', -2);
            changeStat('mood', -5);  // Increased from -3
            changeStat('satiety', -20);
            changeStat('adequacy', -2);  // Increased from -1
            changeStat('incel', 3);  // Increased from 2
            
            // Fatigue recovery
            const oldFatigue = gameState.fatigue;
            gameState.fatigue = Math.floor(gameState.fatigue / 2);
            
            // Check depression AFTER daily changes (mood < 20, not < 0)
            if (gameState.mood < 20) {
                gameState.daysInDepression++;
                gameState.vikaRelationship = Math.max(0, gameState.vikaRelationship - 10);
                
                if (gameState.daysInDepression >= 3) {
                    // Suicide attempt (50% chance)
                    const success = Math.random() < 0.5;
                    gameState.stats.suicideAttempts++;
                    
                    if (success) {
                        // Game over
                        hapticFeedback('error');
                        document.getElementById('gameOverReason').textContent = 'Матвей не выдержал трёх дней депрессии и повесился из-за безответной любви к Вике. 💀';
                        document.getElementById('finalDays').textContent = gameState.day;
                        document.getElementById('gameOverModal').style.display = 'flex';
                        if (isTelegram && tg) {
                            tg.MainButton.hide();
                        }
                        return;
                    } else {
                        // Failed attempt - survived!
                        gameState.mood = 30;
                        changeStat('health', -30);
                        gameState.daysInDepression = 0;
                        addLog(`<strong>💀 Попытка суицида</strong><br>После 3 дней депрессии Матвей попытался повеситься... Но верёвка порвалась! Родители нашли его и вызвали скорую. Второй шанс на жизнь. Настроение: 30, -30 здоровья.`, 'danger');
                        checkAchievementsProgress();
                    }
                } else if (gameState.daysInDepression === 1) {
                    addLog(`<strong>⚠️ Депрессия: 1/3 дня</strong><br>Матвей чувствует себя ужасно. -10 отношений с Викой. Еще 2 дня с настроением <20 - и будет беда!`, 'danger');
                } else if (gameState.daysInDepression === 2) {
                    addLog(`<strong>⚠️ ОПАСНО! Депрессия: 2/3 дня</strong><br>Матвей на грани... -10 отношений с Викой. Еще один день с настроением <20 - попытка суицида!`, 'danger');
                }
            } else {
                gameState.daysInDepression = 0;
            }
            
            if (oldFatigue > 0) {
                addLog(`<strong>💤 День ${gameState.day}</strong><br>Матвей поспал. Усталость: ${oldFatigue} → ${gameState.fatigue}. Деградация: -2 здоровья, -3 настроения, -20 сытости, -1 адекватности, +2 инцельности.`, 'event');
            } else {
                addLog(`<strong>💤 День ${gameState.day}</strong><br>Новый день. Деградация: -2 здоровья, -3 настроения, -20 сытости.`, 'event');
            }
            
            // Случайные события (ЖКХ, гопники)
            checkRandomEvents();
            
            // Проверка голода
            if (gameState.satiety <= 0) {
                gameState.satietyZeroDays++;
                if (gameState.satietyZeroDays >= 1) {
                    addLog(`<strong>⚠️ ГОЛОД!</strong><br>Матвей голодает уже ${gameState.satietyZeroDays} день(дня). При 3 днях - смерть!`, 'danger');
                }
            } else {
                gameState.satietyZeroDays = 0;
            }
            
            // Debt warnings
            if (gameState.money < 0) {
                if (gameState.daysInDebt === 1) {
                    addLog(`<strong>⚠️ Ты в долгах</strong><br>Баланс отрицательный. Если не погасишь долг за 7 дней - коллекторы придут!`, 'danger');
                } else if (gameState.daysInDebt >= 2 && gameState.daysInDebt <= 3) {
                    addLog(`<strong>⚠️ Ты в долгах</strong><br>День ${gameState.daysInDebt}/7 с отрицательным балансом. Нужно срочно заработать!`, 'danger');
                } else if (gameState.daysInDebt >= 4 && gameState.daysInDebt <= 5) {
                    addLog(`<strong>⚠️ ВНИМАНИЕ! Долг уже ${gameState.daysInDebt} дней!</strong><br>Осталось ${7 - gameState.daysInDebt} дня до визита коллекторов!`, 'danger');
                } else if (gameState.daysInDebt === 6) {
                    addLog(`<strong>🚨 КРИТИЧНО! Еще 1 день и коллекторы!</strong><br>СРОЧНО нужны деньги! Баланс: ${gameState.money.toLocaleString('ru-RU')}₽`, 'danger');
                }
            }
            
            hapticFeedback('medium');
            saveGame(); // Full save on sleep
            updateUI();
            checkGameOver();
        }

        // Случайные события
        function checkRandomEvents() {
            // ЖКХ каждый 7-й день - CRITICAL: ALWAYS deducts, can go negative!
            if (gameState.day % 7 === 0) {
                gameState.money -= 5000; // Always deduct, even if negative
                // DO NOT use Math.max here - balance CAN be negative!
                
                if (gameState.money < 0) {
                    addLog(`<strong style="color: #ff6600; font-size: 1.2em;">⚠️ ВНИМАНИЕ! ПРИШЕЛ СЧЕТ ЗА ЖКХ!</strong><br>Списано 5,000₽ за квартиру. Баланс: ${gameState.money.toLocaleString('ru-RU')}₽ <span style="color: #ff4444; font-weight: bold;">(ДОЛГ!)</span>`, 'danger');
                } else {
                    addLog(`<strong style="color: #ff6600; font-size: 1.2em;">⚠️ ВНИМАНИЕ! ПРИШЕЛ СЧЕТ ЗА ЖКХ!</strong><br>Списано 5,000₽ за квартиру. Осталось: ${gameState.money.toLocaleString('ru-RU')}₽`, 'danger');
                }
            }
            
            // Гопники (20% шанс) - CRITICAL FIX: Alternative punishment!
            if (Math.random() < 0.20) {
                const moneyLoss = Math.floor(Math.random() * 2500) + 500;
                const healthLoss = Math.floor(Math.random() * 15) + 5;
                
                if (gameState.money >= moneyLoss) {
                    // Has money - rob normally
                    gameState.money -= moneyLoss;
                    changeStat('health', -healthLoss);
                    changeStat('incel', 10);
                    changeStat('adequacy', -5);
                    addLog(`<strong>⚠️ Гопники!</strong><br>На тебя напали гопники по дороге домой. Отобрали ${moneyLoss.toLocaleString('ru-RU')}₽ и надавали по почкам. -${healthLoss} здоровья, +10 инцельности, -5 адекватности. Осталось: ${gameState.money.toLocaleString('ru-RU')}₽`, 'danger');
                } else {
                    // No money - beat harder!
                    const extraDamage = Math.floor(moneyLoss / 100);  // Convert money to damage
                    const totalHealthLoss = healthLoss + extraDamage;
                    const moodLoss = 20;
                    
                    gameState.money -= moneyLoss;  // Goes into debt!
                    changeStat('health', -totalHealthLoss);
                    changeStat('mood', -moodLoss);
                    changeStat('incel', 15);
                    changeStat('adequacy', -10);
                    
                    addLog(`<strong style="color: #ff0000;">🚨 ГОПНИКИ - НЕТ ДЕНЕГ!</strong><br>Гопники не нашли денег и ЖЕСТКО избили! -${totalHealthLoss} здоровья, -${moodLoss} настроения, +15 инцельности, -10 адекватности. Долг: ${gameState.money.toLocaleString('ru-RU')}₽`, 'danger');
                }
            }
            
            // Другие случайные события
            if (Math.random() < 0.15) {
                const randomEvents = [
                    { 
                        text: 'Нашёл 500₽ на улице! Удача улыбнулась.', 
                        effect: () => { gameState.money += 500; }
                    },
                    { 
                        text: 'Увидел бывшую с новым парнем. Настроение в минус.', 
                        effect: () => { changeStat('mood', -15); changeStat('incel', 10); }
                    },
                    { 
                        text: 'Случайно встретил старого друга. Поболтали, стало легче.', 
                        effect: () => { changeStat('mood', 10); changeStat('adequacy', 5); }
                    },
                    { 
                        text: 'Поймал простуду. Нос течёт, голова болит.', 
                        effect: () => { changeStat('health', -10); }
                    }
                ];
                
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                event.effect();
                addLog(`<strong>🎲 Событие</strong><br>${event.text}`, 'event');
            }
        }

        // Достижения - полный список
        const ALL_ACHIEVEMENTS = {
            survival: [
                { id: 'day7', title: '🎖️ Неделя', desc: 'Прожил 7 дней', check: () => gameState.day === 7 },
                { id: 'day14', title: '🎖️ Две недели', desc: 'Прожил 14 дней', check: () => gameState.day === 14 },
                { id: 'day21', title: '🎖️ Три недели', desc: 'Прожил 21 день', check: () => gameState.day === 21 },
                { id: 'day30', title: '🎖️ Месяц', desc: 'Прожил 30 дней', check: () => gameState.day === 30 },
                { id: 'day50', title: '🎖️ 50 дней', desc: 'Прожил 50 дней', check: () => gameState.day === 50 },
                { id: 'day100', title: '🎖️ Легенда', desc: 'Прожил 100 дней!', check: () => gameState.day === 100 }
            ],
            relationships: [
                { id: 'firstCall', title: '📞 Первый звонок', desc: 'Позвонил Вике первый раз', check: () => (gameState.stats.vikaCallsSuccess + gameState.stats.vikaCallsFail) === 1 },
                { id: 'successDate', title: '💖 Удачное свидание', desc: 'Успешный звонок Вике', check: () => gameState.stats.vikaCallsSuccess >= 1 },
                { id: 'persistent', title: '💪 Настойчивый', desc: '5 успешных звонков', check: () => gameState.stats.vikaCallsSuccess >= 5 },
                { id: 'simp', title: '💸 Симп', desc: 'Потратил 50,000₽ на Вику', check: () => gameState.stats.vikaMoneySpent >= 50000 },
                { id: 'vikaLove50', title: '💕 Симпатия', desc: 'Отношения с Викой 50+', check: () => gameState.vikaRelationship >= 50 },
                { id: 'vikaLove100', title: '💖 Любовь Вики', desc: 'Максимальные отношения (100/100)', check: () => gameState.vikaRelationship >= 100 }
            ],
            degradation: [
                { id: 'firstPost', title: '📱 Первый пост', desc: 'Запостил в АЯЕЧ', check: () => gameState.stats.postsCount === 1 },
                { id: 'activePoster', title: '🔥 Активист АЯЕЧ', desc: '10 постов', check: () => gameState.stats.postsCount >= 10 },
                { id: 'trashKing', title: '🗑️ Король помойки', desc: 'Поел из помойки 5 раз', check: () => gameState.stats.trashMeals >= 5 },
                { id: 'dickpicMaster', title: '🍆 Дикпик мастер', desc: 'Сфоткал пенис 3 раза', check: () => gameState.stats.dickPics >= 3 },
                { id: 'maxIncel', title: '🤡 Максимальная инцельность', desc: 'Инцельность 100', check: () => gameState.incel >= 100 }
            ],
            debt: [
                { id: 'inDebt', title: '💸 В долгах', desc: 'Впервые ушел в минус', check: () => gameState.money < 0 },
                { id: 'debtEscape', title: '💰 Выбрался из долгов', desc: 'Вернулся из минуса в плюс', check: () => gameState.money >= 0 && gameState.stats.wasInDebt },
                { id: 'bankrupt2', title: '🚫 Банкрот', desc: 'Долг достиг -20,000₽', check: () => gameState.money <= -20000 },
                { id: 'onEdge', title: '⚠️ На грани', desc: 'Дожил до 6 дней в долгу и выбрался', check: () => gameState.money >= 0 && gameState.stats.maxDebtDays >= 6 }
            ],
            health: [
                { id: 'firstHospital', title: '🏥 Первый визит', desc: 'Сходил в больницу', check: () => gameState.stats.hospitalVisits === 1 },
                { id: 'regularPatient', title: '🩺 Постоянный пациент', desc: '5 визитов в больницу', check: () => gameState.stats.hospitalVisits >= 5 },
                { id: 'survivor', title: '💪 Выживший', desc: 'Пережил попытку суицида', check: () => gameState.stats.suicideAttempts >= 1 },
                { id: 'willpower', title: '🧠 Сила воли', desc: 'Адекватность 80+', check: () => gameState.adequacy >= 80 }
            ],
            work: [
                { id: 'firstShift', title: '🛠️ Первая смена', desc: 'Поработал первый раз', check: () => gameState.stats.workShifts === 1 },
                { id: 'hardWorker', title: '💼 Трудяга', desc: '10 смен на работе', check: () => gameState.stats.workShifts >= 10 },
                { id: 'rich', title: '💰 Богатый', desc: 'Накопил 50,000₽', check: () => gameState.money >= 50000 },
                { id: 'bankrupt', title: '🚫 Банкрот', desc: 'Деньги упали до 0', check: () => gameState.money <= 0 && gameState.day > 1 }
            ],
            metro: [
                { id: 'firstMetro', title: '🚇 Первая поездка', desc: 'Прокатился в метро', check: () => gameState.stats.metroRides === 1 },
                { id: 'passenger', title: '🎫 Пассажир', desc: '10 поездок в метро', check: () => gameState.stats.metroRides >= 10 },
                { id: 'metroRegular', title: '🚇 Завсегдатай метро', desc: '50 поездок', check: () => gameState.stats.metroRides >= 50 },
                { id: 'fined', title: '🚨 Штрафник', desc: 'Попался контролерам', check: () => gameState.stats.metroFined >= 1 },
                { id: 'godSlayer', title: '👑 Убийца Бога', desc: 'Снизил комплекс бога метро с 100+', check: () => gameState.godComplex < 50 && gameState.stats.metroRides >= 3 }
            ],
            lifestyle: [
                { id: 'clean', title: '🚿 Чистюля', desc: 'Помылся 10 раз', check: () => gameState.stats.washCount >= 10 },
                { id: 'stylish', title: '🧔 Модник', desc: 'Побрился 10 раз', check: () => gameState.stats.shaveCount >= 10 },
                { id: 'hermit', title: '🏠 Социофоб', desc: 'Не выходил из дома 7 дней', check: () => gameState.stats.daysWithoutOutside >= 7 },
                { id: 'social', title: '🚶 Гуляка', desc: 'Выходил из дома 10 раз', check: () => gameState.stats.outsideCount >= 10 }
            ]
        };

        // Проверка достижений
        function checkAchievementsProgress() {
            Object.keys(ALL_ACHIEVEMENTS).forEach(category => {
                ALL_ACHIEVEMENTS[category].forEach(ach => {
                    if (!gameState.achievements.includes(ach.id) && ach.check()) {
                        gameState.achievements.push(ach.id);
                        addLog(`<strong>🏆 ДОСТИЖЕНИЕ!</strong><br>${ach.title}: ${ach.desc}`, 'event');
                        updateAchievementsDisplay();
                    }
                });
            });
        }

        function updateAchievementsDisplay() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            // Show first 3 unlocked or next to unlock
            let shown = 0;
            Object.keys(ALL_ACHIEVEMENTS).forEach(category => {
                ALL_ACHIEVEMENTS[category].forEach(ach => {
                    if (shown < 3) {
                        const isUnlocked = gameState.achievements.includes(ach.id);
                        const div = document.createElement('div');
                        div.className = 'achievement' + (isUnlocked ? '' : ' locked');
                        div.textContent = ach.title;
                        container.appendChild(div);
                        shown++;
                    }
                });
            });
        }

        // Проверка условий Game Over
        function checkGameOver() {
            let gameOver = false;
            let reason = '';
            
            if (gameState.health <= 0) {
                gameOver = true;
                reason = 'Твоё здоровье опустилось до нуля. Организм не выдержал...';
            } else if (gameState.satietyZeroDays >= 3) {
                gameOver = true;
                reason = 'Ты не ел уже 3 дня. Голодная смерть настигла тебя...';
            } else if (gameState.godComplex >= 100) {
                gameOver = true;
                reason = 'Комплекс Бога достиг максимума. Ты окончательно оторвался от реальности...';
            } else if (gameState.daysInDebt >= 7) {
                gameOver = true;
                reason = 'Матвей не смог выплатить долги. Коллекторы пришли... 💀';
            }
            
            // Show warnings for critical states
            if (gameState.mood < 20 && Math.random() < 0.3) {
                addLog(`<strong>💡 Совет</strong><br>⚠️ ДЕПРЕССИЯ! Настроение низкое! Попробуй: подрочить (+10), заказать Мамбу (+40), или постить в АЯЕЧ (+10).`, 'event');
            }
            if (gameState.godComplex > 70 && Math.random() < 0.3) {
                addLog(`<strong>⚠️ Внимание!</strong><br>ЭГО на пределе! Комплекс бога: ${Math.round(gameState.godComplex)}/100. При 100 - game over!`, 'danger');
            }
            if (gameState.adequacy < 20 && Math.random() < 0.3) {
                addLog(`<strong>⚠️ Внимание!</strong><br>Ты совсем поехал! Адекватность: ${Math.round(gameState.adequacy)}/100.`, 'danger');
            }
            
            if (gameOver) {
                hapticFeedback('error');
                document.getElementById('gameOverReason').textContent = reason;
                document.getElementById('finalDays').textContent = gameState.day;
                document.getElementById('gameOverModal').style.display = 'flex';
                if (isTelegram && tg) {
                    tg.MainButton.hide();
                }
            }
        }

        // Toast notification function
        function showWelcomeToast() {
            const toast = document.getElementById('welcome-toast');
            if (!toast) return;
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                
                // Fully remove after animation
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('fade-out');
                }, 500);
            }, 5000);
        }

        // UI functions for modals
        function closeTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            tutorialClosed = true;
            
            // Show welcome toast after closing tutorial
            setTimeout(() => {
                showWelcomeToast();
            }, 300);
        }

        function showAchievements() {
            const container = document.getElementById('achievementsFullList');
            let html = '';
            
            const categoryNames = {
                survival: '🎖️ Выживание',
                relationships: '💖 Отношения',
                degradation: '🤡 Деградация',
                health: '❤️ Здоровье',
                work: '💼 Работа',
                metro: '🚇 Метро',
                lifestyle: '🏠 Образ жизни',
                debt: '💸 Долги'
            };
            
            Object.keys(ALL_ACHIEVEMENTS).forEach(category => {
                html += `<h3 style="color: var(--color-primary); margin-top: 20px;">${categoryNames[category]}</h3>`;
                ALL_ACHIEVEMENTS[category].forEach(ach => {
                    const isUnlocked = gameState.achievements.includes(ach.id);
                    const style = isUnlocked ? 'color: var(--color-warning); font-weight: bold;' : 'color: var(--color-text-dim);';
                    const icon = isUnlocked ? '✅' : '🔒';
                    html += `<p style="${style}">${icon} ${ach.title} - ${ach.desc}</p>`;
                });
            });
            
            const unlockedCount = gameState.achievements.length;
            const totalCount = Object.values(ALL_ACHIEVEMENTS).reduce((sum, cat) => sum + cat.length, 0);
            html = `<p style="text-align: center; font-size: 1.2em; margin-bottom: 20px;">Разблокировано: <strong>${unlockedCount}/${totalCount}</strong></p>` + html;
            
            container.innerHTML = html;
            document.getElementById('achievementsModal').style.display = 'flex';
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').style.display = 'none';
        }

        function showStatistics() {
            const s = gameState.stats;
            const html = `
                <p><strong>📅 Дней прожито:</strong> ${gameState.day}</p>
                <p><strong>💰 Всего заработано:</strong> ${s.totalMoneyEarned.toLocaleString('ru-RU')}₽</p>
                <p><strong>💼 Рабочих смен:</strong> ${s.workShifts}</p>
                <p><strong>💖 Отношения с Викой:</strong> ${Math.round(gameState.vikaRelationship)}/100</p>
                <p><strong>📞 Звонков Вике (успешных):</strong> ${s.vikaCallsSuccess}</p>
                <p><strong>🚫 Звонков Вике (отказов):</strong> ${s.vikaCallsFail}</p>
                <p><strong>💸 Потрачено на Вику:</strong> ${s.vikaMoneySpent.toLocaleString('ru-RU')}₽</p>
                <p><strong>📱 Постов в АЯЕЧ:</strong> ${s.postsCount}</p>
                <p><strong>🗑️ Приёмов пищи из помойки:</strong> ${s.trashMeals}</p>
                <p><strong>🍆 Фоток пениса:</strong> ${s.dickPics}</p>
                <p><strong>🏥 Визитов в больницу:</strong> ${s.hospitalVisits}</p>
                <p><strong>🚿 Раз помылся:</strong> ${s.washCount}</p>
                <p><strong>🧔 Раз побрился:</strong> ${s.shaveCount}</p>
                <p><strong>🚶 Выходов из дома:</strong> ${s.outsideCount}</p>
                <p><strong>🚇 Поездок в метро:</strong> ${s.metroRides}</p>
                <p><strong>🚨 Штрафов от контролеров:</strong> ${s.metroFined}</p>
                <p><strong>💀 Попыток суицида:</strong> ${s.suicideAttempts}</p>
            `;
            document.getElementById('statisticsContent').innerHTML = html;
            document.getElementById('statisticsModal').style.display = 'flex';
        }

        function closeStatistics() {
            document.getElementById('statisticsModal').style.display = 'none';
        }

        // Перезапуск игры
        function restartGame() {
            gameState = {
                health: 100,
                mood: 50,
                satiety: 100,
                adequacy: 20,
                incel: 80,
                godComplex: 40,
                fatigue: 0,
                money: 25000,
                day: 1,
                vikaRelationship: 0,
                parentFoodToday: 0,
                satietyZeroDays: 0,
                daysInDepression: 0,
                daysInDebt: 0,
                hospitalToday: false,
                achievements: [],
                stats: {
                    totalMoneyEarned: 0,
                    workShifts: 0,
                    vikaCallsSuccess: 0,
                    vikaCallsFail: 0,
                    vikaMoneySpent: 0,
                    postsCount: 0,
                    trashMeals: 0,
                    dickPics: 0,
                    hospitalVisits: 0,
                    washCount: 0,
                    shaveCount: 0,
                    outsideCount: 0,
                    daysWithoutOutside: 0,
                    suicideAttempts: 0,
                    metroRides: 0,
                    metroFined: 0,
                    wasInDebt: false,
                    maxDebtDays: 0
                }
            };
            
            // CRITICAL: Очистка лога
            const log = document.getElementById('eventLog');
            if (log) {
                log.innerHTML = ''; // Полная очистка
                // Добавить первое сообщение через addLog
                addLog('<strong>🎮 Новая игра!</strong><br>Ты снова Матвей. Попробуй прожить дольше на этот раз...', 'event');
            }
            
            // Сброс достижений
            updateAchievementsDisplay();
            
            document.getElementById('gameOverModal').style.display = 'none';
            
            // Restore Telegram Main Button
            if (isTelegram && tg) {
                tg.MainButton.show();
            }
            
            hapticFeedback('success');
            saveGame();
            updateUI();
        }

        // Инициализация игры
        document.addEventListener('DOMContentLoaded', () => {
            // CRITICAL: Очистка event log от статических сообщений
            const eventLog = document.getElementById('eventLog');
            if (eventLog) {
                eventLog.innerHTML = ''; // Удалить все статические HTML сообщения
            }
            
            // Initialize Telegram Web App
            const telegramInitialized = initTelegram();
            
            if (telegramInitialized) {
                console.log('🚀 Running in Telegram Mini App');
                // Show share button in Telegram
                const shareBtn = document.getElementById('shareBtn');
                if (shareBtn) shareBtn.style.display = 'inline-flex';
                
                // Load from Telegram Cloud
                loadGameFromTelegram();
            } else {
                console.log('🌐 Running in browser');
                updateUI();
            }
            
            updateAchievementsDisplay();
            checkAchievementsProgress();
            setupTutorialAutoClose();
            
            // Save on page hide
            window.addEventListener('pagehide', () => {
                saveGame();
            });
            
            window.addEventListener('beforeunload', () => {
                saveGame();
            });
        });
        
        // Show patch notes
        setTimeout(() => {
            if (!tutorialClosed) return;  // Don't show if tutorial is open
            
            const patchNotes = `<div style="background: #1a3a1a; border: 2px solid var(--color-success); padding: 15px; border-radius: 10px;">
                    <h3 style="color: var(--color-success); margin-bottom: 10px;">📋 TELEGRAM MINI APP v2.0</h3>
                    
                    ${isTelegram ? '<p style="color: #4a9eff; font-weight: bold;">🚀 Запущено в Telegram!</p>' : '<p style="color: #ffaa00;">🌐 Режим браузера (для Telegram откройте через бота)</p>'}
                    
                    <h4 style="color: #4a9eff; margin-top: 10px;">✨ TELEGRAM ИНТЕГРАЦИЯ:</h4>
                    <ul style="line-height: 1.8; margin-left: 20px;">
                        <li>☁️ <strong>Cloud Storage</strong> - автосохранение в облако Telegram</li>
                        <li>📳 <strong>Haptic Feedback</strong> - тактильная обратная связь при действиях</li>
                        <li>🎨 <strong>Адаптивная тема</strong> - использует цвета Telegram</li>
                        <li>💾 <strong>Главная кнопка</strong> - быстрое сохранение игры</li>
                        <li>📤 <strong>Поделиться</strong> - отправить результат друзьям</li>
                        <li>📱 <strong>Touch UI</strong> - оптимизация для мобильных</li>
                    </ul>
                    
                    <h4 style="color: #ff6666; margin-top: 10px;">🎯 ЧТО НОВОГО В v1.6:</h4>
                    
                    <h4 style="color: #ff6666; margin-top: 10px;">🎯 НОВОЕ В v1.6:</h4>
                    <ul style="line-height: 1.8; margin-left: 20px;">
                        <li>🔞 <strong>Дрочка заблокирована при усталости ≥80</strong> - логично, что уставший человек не может этого делать</li>
                        <li>⚠️ <strong>Визуальная блокировка кнопки</strong> - кнопка становится серой и показывает причину</li>
                        <li>💬 <strong>Сообщение при попытке</strong> - "Слишком устал даже для этого..."</li>
                        <li>💤 <strong>Решение</strong> - нужно поспать, чтобы снизить усталость вдвое</li>
                    </ul>
                    
                    <h4 style="color: #4a9eff; margin-top: 10px;">⚖️ БАЛАНС ИГРЫ:</h4>
                    <ul style="line-height: 1.8; margin-left: 20px;">
                        <li>✅ Все действия сбалансированы и имеют последствия</li>
                        <li>✅ Усталость теперь блокирует: работу, прогулки, постинг, метро, <strong>ДРОЧКУ</strong></li>
                        <li>✅ Комплекс бога блокирует: гигиену и выход из дома</li>
                        <li>✅ Деньги/параметры блокируют: Вику, Мамбу, больницу</li>
                    </ul>
                    
                    <p style="margin-top: 15px; color: var(--color-success); font-weight: bold;">🎮 ИГРА ГОТОВА! Все механики работают корректно! 🚀</p>
                </div>`;
            
            // Использовать addLog для добавления
            addLog(patchNotes, 'event');
        }, 500);
    </script>
</body>
</html>